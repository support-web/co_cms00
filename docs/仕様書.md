# Mobile-First CMS 仕様書（仕様書.md）
> 目的：この仕様書を生成AIに渡すことで、WordPressのように「サイトを簡単に構築・運用できる」モバイルファーストCMS（以下、本CMS）を実装できるレベルの要件・設計指針を提供する。  
> 方針：**強い前提（Opinionated）**を置き、AIが迷わず実装できるようにする。

---

## 1. 概要

### 1.1 プロダクト名（仮）
- **MFCMS（Mobile First CMS）**

### 1.2 背景
- 既存CMS（WordPress等）はテーマ/プラグイン依存が強く、モバイルファーストのUI/UX・高速表示・運用の簡便性を一貫して担保するのが難しい。
- 本CMSは「スマホで見たときに最適」を第一に、**ブロック/セクション**で直感的にページを組み立て、**高速配信（SSG/ISR）**を標準化する。

### 1.3 ゴール（Goals）
- ノーコード/ローコードでモバイルファーストなWebサイトを構築できる。
- 管理画面はスマホでも編集できる（最低限）。ただし主要編集はPC想定。
- サイト公開は「下書き→公開→ロールバック」可能。
- テンプレート（Theme）とブロック（Block）の組み合わせで柔軟に表現できる。
- 生成AIがこの仕様書から、**API・DB・管理UI・公開サイト**を一貫して実装できる。

### 1.4 非ゴール（Non-Goals / MVP外）
- 汎用プラグインマーケット、外部配布用SDKの整備（Phase2以降）。
- フル機能EC（決済・在庫・注文管理）はMVP外（必要なら別仕様）。
- 複雑なWYSIWYG（Word互換の細密組版）はMVP外（ブロックで代替）。

---

## 2. ターゲットユーザー / ペルソナ
- **個人/小規模事業者**：LPや小規模コーポレートサイトを素早く作りたい。
- **制作会社**：複数クライアントのサイトを同一基盤で管理したい。
- **運用担当**：記事/お知らせ/固定ページを更新したい（権限管理が必要）。

---

## 3. 用語定義
- **テナント（Tenant）**：組織/顧客単位の管理領域。
- **サイト（Site）**：公開される1つのWebサイト単位（テナント配下に複数持てる）。
- **ページ（Page）**：固定ページ。URLスラッグを持つ。
- **投稿（Post）**：ブログ/お知らせ等の時系列コンテンツ。
- **ブロック（Block）**：ページを構成する最小単位（Hero、Text、Image、CTA等）。
- **セクション（Section）**：複数ブロックのまとまり（レイアウト単位）。
- **テーマ（Theme）**：見た目（トークン/テンプレ/コンポーネントセット）。
- **スロット（Slot）**：テンプレ上の差し込み箇所（Header/Main/Footer等）。

---

## 4. 全体要件（MVP必須）

### 4.1 マルチテナント / マルチサイト
- 1ユーザーは複数テナントに所属可能。
- 1テナントは複数サイトを所有可能（制作会社ユースケース）。
- データ分離：**tenant_id**で論理分離（Row-level分離）。将来的にDB分割可能な設計にする。

### 4.2 コンテンツ管理
- Page / Post（標準）
- Taxonomy（Category / Tag）
- Media（画像/動画/ファイル）
- Menu（ナビゲーション）
- Global Components（サイト共通のヘッダー/フッター/CTAなどの再利用部品）
- Draft/Publish、スケジュール公開、ロールバック（直近N世代）

### 4.3 モバイルファースト・ページビルダー
- **モバイル（375px幅）を基準**に編集し、タブレット/デスクトップは拡張として扱う。
- ブロックは以下を満たす：
  - レイアウトプリセット（例：2カラムはデスクトップのみ、モバイルは縦積み）
  - タイポ・余白・色はテーマトークンで統制
  - 画像は自動最適化（サイズ/フォーマット）
- 編集体験：
  - 左：ページツリー（Section/Block）
  - 中央：キャンバス（モバイル基準、ブレークポイント切替）
  - 右：プロパティパネル（選択ブロックの設定）
  - DnDで並べ替え、複製、削除、非表示（デバイス別）

### 4.4 テーマ / デザインシステム
- テーマは「**デザイントークン + テンプレート + ブロック実装**」で構成。
- トークン例：
  - colors（primary/secondary/background/text/border）
  - typography（fontFamily, fontSizeScale, lineHeightScale）
  - spacing（4px基準のスケール）
  - radius, shadow
- 1サイトに1テーマ適用（MVP）。テーマ切替は可能だが、ブロック互換がない場合は警告表示。

### 4.5 公開サイトのレンダリング方式
- 公開サイトは **SSG + ISR（インクリメンタル再生成）** を基本とする。
- 変更検知：公開操作 or スケジュール公開時に再生成キューを投入。
- CDNキャッシュ前提。HTML/JSONをエッジに配信。
- ルーティング：
  - `/` ホーム
  - `/p/:slug` ページ
  - `/blog/:slug` 投稿（例）
  - カスタムパス（MVPはページに任意パス許可：`/about` 等）

### 4.6 SEO / メタ
- title/description/OGP/twitterカード、canonical
- sitemap.xml 自動生成
- robots.txt 管理
- structured data（Article/Organization等の基本）
- 画像alt必須（未設定は警告）

### 4.7 多言語（MVP最小）
- MVP：サイト単位の言語（ja/en）を設定可能。コンテンツの多言語化はPhase2。

---

## 5. 非機能要件

### 5.1 パフォーマンス
- 公開ページのLCP改善を優先（画像最適化、SSRを避ける）。
- TTFB：CDNキャッシュヒット時 100ms目標（環境依存）。
- 管理画面は初期表示3秒以内（一般的な回線）。

### 5.2 セキュリティ
- 認証：メール+パスワード（MVP）、将来OAuth追加可能。
- セッション：HttpOnly Cookie + CSRF対策（同一サイトcookie + CSRFトークン）
- RBAC（権限）
- Rate limit（ログイン/投稿系）
- XSS：HTMLを原則禁止（ブロックのプロパティで安全に表現）。どうしても必要な場合は「安全な限定HTML」モードを用意（管理者のみ）。
- ファイルアップロード：拡張子/Content-Type検証、サイズ制限、オブジェクトストレージへ隔離保存。
- 監査ログ（誰が何を変更したか）

### 5.3 可観測性
- API：構造化ログ、トレースID、エラー集計
- 管理画面：主要操作イベント（公開/ロールバック）
- ヘルスチェック / メトリクス（/health, /metrics）

### 5.4 バックアップ / リストア
- DB：日次スナップショット
- メディア：オブジェクトストレージのバージョニング推奨
- サイト単位のエクスポート（JSON + assets一覧）

---

## 6. 権限設計（RBAC）

### 6.1 役割
- **Owner**：課金/テナント管理含む全権限
- **Admin**：サイト設定、テーマ、公開、ユーザー管理
- **Editor**：コンテンツ作成/編集/公開申請（公開は不可でも可：設定で切替）
- **Author**：自分の投稿作成/編集（公開は不可）
- **Viewer**：閲覧のみ

### 6.2 権限マトリクス（MVP）
- ユーザー管理：Owner/Admin
- サイト設定：Owner/Admin
- ページ編集：Owner/Admin/Editor
- 投稿編集：Owner/Admin/Editor/Author（自分のみ）
- 公開：Owner/Admin（Editorは設定で許可可能）
- テーマ変更：Owner/Admin
- メディア管理：Owner/Admin/Editor/Author（自分のアップロード）

---

## 7. 画面（管理UI）要件

### 7.1 共通
- 左サイドバー：Dashboard / Pages / Posts / Media / Menus / Theme / Settings / Users
- 上部：サイト切替、プレビュー、公開状態、ユーザーアイコン

### 7.2 Dashboard
- 最近更新したコンテンツ
- 公開待ち（レビュー）
- ビルド状況（再生成キューの状態）

### 7.3 Pages / Posts 一覧
- 検索（title/slug）
- ステータス（draft/scheduled/published/archived）
- フィルタ（作者、更新日）
- 一括操作（下書き化、アーカイブ、削除）

### 7.4 エディタ（Page Builder）
- ブレークポイント切替：Mobile(375) / Tablet(768) / Desktop(1024+)
- DnD：Section/Blockの並べ替え
- ブロック追加：カテゴリ（Hero/Text/Media/Forms/Navigation/Embed）
- プロパティ：
  - content（テキスト、画像、リンク）
  - style（トークン参照、例：色はテーマのprimary等）
  - visibility（device別表示/非表示）
  - layout（padding/margin、grid等）※許容範囲を制限
- 変更履歴：自動保存（30秒ごと）+ 手動スナップショット
- プレビュー：公開URL想定でのプレビュー（認証付きプレビューも可）

### 7.5 Media Library
- アップロード（ドラッグ&ドロップ）
- フォルダ（MVPはタグで代替可）
- 自動生成：サムネイル、WebP/AVIF（環境依存）
- 画像編集（MVPはトリミング程度、Phase2で拡張）

### 7.6 Menus
- メニューセット（Header/Footer/Drawer）
- 階層（2階層までMVP）
- リンク先：ページ/投稿/外部URL

### 7.7 Theme
- テーマ選択（MVPは標準2〜3テーマ同梱）
- トークン編集（色・フォント・角丸）
- 変更のプレビュー、適用、ロールバック

### 7.8 Settings
- Site基本：名称、説明、言語、タイムゾーン
- Domain：カスタムドメイン（MVPは1つ、Phase2で複数）
- SEO：サイト全体のメタ、OGP画像
- Analytics：タグ挿入（GTM等、MVPは単一スニペット）
- Robots/Sitemap

### 7.9 Users
- ユーザー招待（メール）
- ロール付与、削除
- 監査ログ閲覧

---

## 8. ブロック仕様（MVP）

### 8.1 ブロック共通インターフェース
- id（UUID）
- type（string）
- props（JSON）
- style（JSON：トークン参照中心）
- visibility（mobile/tablet/desktop）
- dataBinding（将来用：MVPは未使用でも字段を残す）

### 8.2 ブロック種類（必須）
1. **Hero**
   - title, subtitle, backgroundImage, cta(label,url)
   - alignment（center/left）
2. **RichText**
   - 内容：構造化（ProseMirror/TipTap JSON想定）
   - 禁止：任意script/style
3. **Image**
   - src, alt, caption, link
4. **Gallery**
   - images[]（最大12）
5. **Button / CTA**
   - label, url, variant（primary/secondary）
6. **Columns**
   - 子ブロックを2分割（desktop）・モバイルは縦積み固定
7. **Spacer**
   - height（トークン/数値上限）
8. **Embed**
   - YouTube / GoogleMap / iframe（許可ドメイン制限）
9. **Header / Footer（Global）**
   - メニュー連動、ロゴ、SNSリンク

※フォーム（Contact）はPhase1.5またはPhase2でも可。MVPに入れる場合：メール送信は外部（SendGrid等）設定が必要。

---

## 9. データ設計（DB）

### 9.1 DB（推奨）
- PostgreSQL（UUID主キー）
- ORM：Prisma（TypeScript想定）

### 9.2 テーブル（MVP）
- tenants
  - id, name, created_at
- users
  - id, email, password_hash, name, created_at, last_login_at
- memberships
  - id, tenant_id, user_id, role, created_at
- sites
  - id, tenant_id, name, slug, locale, timezone, theme_id, created_at
- domains
  - id, site_id, hostname, is_primary, verified_at
- themes
  - id, name, version, tokens_json, created_at
- pages
  - id, site_id, title, slug, path, status, published_at, scheduled_at, author_id, updated_at, created_at
- posts
  - id, site_id, title, slug, status, published_at, scheduled_at, author_id, updated_at, created_at
- content_revisions
  - id, site_id, entity_type(page/post/global), entity_id, version, content_json, created_at, created_by
- media
  - id, site_id, uploader_id, type, filename, size, mime, storage_key, width, height, alt, created_at
- menus
  - id, site_id, name, location(header/footer/drawer), created_at
- menu_items
  - id, menu_id, parent_id, label, url, ref_type(page/post/external), ref_id, sort_order
- audit_logs
  - id, tenant_id, site_id, actor_id, action, target_type, target_id, payload_json, created_at
- publish_jobs
  - id, site_id, status(queued/running/success/failed), reason, started_at, finished_at, log

### 9.3 ステータス定義
- draft：下書き
- scheduled：予約
- published：公開
- archived：非表示（削除は原則管理者のみ）

### 9.4 一意制約（例）
- domains.hostname unique
- pages.site_id + pages.path unique
- posts.site_id + posts.slug unique
- menus.site_id + menus.location unique

---

## 10. API設計（REST / JSON）

### 10.1 認証
- POST `/api/auth/login`
- POST `/api/auth/logout`
- POST `/api/auth/refresh`
- POST `/api/auth/invite`（Owner/Admin）
- POST `/api/auth/accept-invite`

### 10.2 テナント/サイト
- GET `/api/tenants`
- GET `/api/sites?tenantId=...`
- POST `/api/sites`
- PATCH `/api/sites/:id`
- GET `/api/sites/:id`
- POST `/api/sites/:id/domains`
- PATCH `/api/domains/:id/verify`（DNS/HTTP検証：MVPは手動フラグでも可）

### 10.3 ページ/投稿
- GET `/api/sites/:siteId/pages`
- POST `/api/sites/:siteId/pages`
- GET `/api/pages/:id`
- PATCH `/api/pages/:id`
- POST `/api/pages/:id/publish`
- POST `/api/pages/:id/schedule`
- POST `/api/pages/:id/rollback?version=N`
- 同様に posts

### 10.4 リビジョン
- GET `/api/:entityType/:id/revisions`
- GET `/api/revisions/:revisionId`

### 10.5 メディア
- POST `/api/sites/:siteId/media/presign`（S3互換の署名URL発行）
- POST `/api/sites/:siteId/media/complete`（メタ登録）
- GET `/api/sites/:siteId/media`
- PATCH `/api/media/:id`（alt等）
- DELETE `/api/media/:id`（参照がある場合は不可）

### 10.6 メニュー
- GET `/api/sites/:siteId/menus`
- PUT `/api/menus/:id`（itemsを含めて更新）

### 10.7 テーマ
- GET `/api/themes`
- GET `/api/themes/:id`
- PATCH `/api/themes/:id/tokens`
- POST `/api/sites/:siteId/theme/apply`

### 10.8 公開ビルド（再生成）
- POST `/api/sites/:siteId/publish-jobs`（理由：page publish等）
- GET `/api/sites/:siteId/publish-jobs?limit=20`
- GET `/api/publish-jobs/:id`

---

## 11. 公開サイト（Web）実装要件

### 11.1 表示方式
- 公開WebはNext.js等でSSG/ISR。
- CMS APIから「公開済みのページJSON」を取得し、ブロックレンダラーで描画。
- ブロックレンダラーは**テーマ**と**トークン**を参照し、CSS（Tailwind等）で実装。

### 11.2 キャッシュ
- ページJSONはCDNキャッシュ可能（公開後はバージョン付きURL or ETag）
- 予約公開時刻に合わせて再生成

### 11.3 画像最適化
- 画像はオブジェクトストレージへ保存し、公開側で最適サイズを要求（`w=`クエリ等）
- 可能なら画像プロキシ（Cloudflare Images等）を後付け可能にする。MVPはローカル変換でも可。

---

## 12. 技術スタック（推奨・MVPの実装前提）
> AIが実装しやすいように、ここでは推奨スタックを固定する（必要なら置換可能）。

### 12.1 言語/構成
- TypeScript（全体統一）
- Monorepo（pnpm + Turborepo 推奨）

### 12.2 アプリ構成
- `apps/admin`：管理画面（Next.js）
- `apps/web`：公開サイト（Next.js）
- `apps/api`：API（NestJS or Fastify）
- `packages/ui`：共通UI（Tailwind + shadcn/ui想定）
- `packages/sdk`：APIクライアント（OpenAPI生成 or 手書き）
- `packages/blocks`：ブロック定義/レンダラー

### 12.3 DB/Storage
- PostgreSQL
- Redis（セッション/キュー/キャッシュ）
- オブジェクトストレージ：S3互換（AWS S3 / MinIO）

### 12.4 キュー
- BullMQ（Redis）で publish_jobs を処理

### 12.5 OpenAPI
- APIはOpenAPI（Swagger）を自動生成し、型安全SDKを生成する。

---

## 13. 監査ログ（Audit）要件
- 重要操作：ログイン、ユーザー招待、権限変更、ページ公開、テーマ適用、ロールバック、ドメイン変更
- payload_jsonに差分（before/after）の最小情報を入れる（サイズ上限あり）

---

## 14. バリデーション / ルール
- ページpathは先頭`/`、末尾`/`は正規化（例：`/about`）
- slugは `[a-z0-9-]+` を基本（日本語スラッグはMVP不可）
- 画像alt未設定：公開時に警告（ブロックで画像を使う場合）
- Embed：許可ドメインリスト（YouTube, Google Maps等）

---

## 15. 受け入れ基準（Acceptance Criteria：MVP）
1. テナント作成→サイト作成→テーマ適用→トップページをブロックで作成→公開→公開URLで閲覧できる。
2. モバイル/デスクトップのプレビュー切替ができ、モバイルで崩れない。
3. 下書き保存、自動保存、公開、ロールバックが動作する。
4. メディアアップロード→Imageブロックで利用→公開ページで最適サイズ表示（少なくとも縮小表示）
5. RBACが機能し、Authorが他人の投稿を編集できない。
6. sitemap.xml が生成され、主要ページが含まれる。
7. 監査ログに「誰が公開したか」が残る。

---

## 16. 開発フェーズ（推奨）

### Phase 0（基盤）
- 認証、RBAC、テナント/サイト、DBスキーマ、管理画面の骨格

### Phase 1（MVP）
- Pages/Posts、Builder、Media、Theme、Publish_jobs、公開Web（SSG/ISR）

### Phase 1.5（強化）
- Contactフォーム、レビュー承認フロー、画像変換強化、デバイス別表示

### Phase 2（拡張）
- 多言語（1コンテンツ複数ロケール）、プラグイン機構、テンプレマーケット、A/B、EC連携

---

## 17. リポジトリ構成（例）
```text
repo/
  apps/
    admin/         # 管理画面（Next.js）
    web/           # 公開サイト（Next.js）
    api/           # API（NestJS/Fastify）
  packages/
    ui/            # 共通UI
    sdk/           # API SDK
    blocks/        # ブロック定義、レンダラー
    config/        # eslint/tsconfig等
  infra/
    docker/        # docker-compose（postgres, redis, minio）
    migrations/
  docs/
    仕様書.md
```

---

## 18. 生成AI実装指示（この仕様書の使い方）
生成AIには以下の順で実装させる：
1. monorepo初期化（pnpm + turbo）
2. Postgres/Redis/MinIOのdocker-compose
3. Prismaでスキーマ作成→migration
4. API（認証/RBAC/CRUD/Publish_jobs）
5. Admin（一覧/エディタ/テーマ/メディア）
6. Web（ブロックレンダラー + SSG/ISR）
7. テスト（APIユニット + E2E最小）
8. デプロイ（Docker or Vercel + managed DB）

AIへの追加制約（推奨）
- すべてTypeScriptで統一
- 例外/エラーは共通フォーマット（code, message, details）
- APIはOpenAPIを常に更新
- ブロックpropsはJSON Schemaで定義し、管理画面と公開側で共有

---

## 19. 追加オプション（必要なら別途仕様化）
- テンプレートギャラリー（業種別プリセット）
- AIアシスト（テキスト生成、レイアウト提案）
- コンテンツインポート（WordPress XML、Markdown）
- 画像の自動タグ付け（生成AI）

---

## 20. 最低限の成果物リスト（実装時に生成されるべきもの）
- OpenAPI仕様（`apps/api/openapi.json`）
- Prisma schema（`apps/api/prisma/schema.prisma`）
- ブロック定義（`packages/blocks/*.ts` + JSON Schema）
- Admin UI（主要画面一式）
- Webレンダラー（`apps/web`）
- docker-compose（`infra/docker/docker-compose.yml`）
- README（セットアップ、環境変数、運用手順）

---
